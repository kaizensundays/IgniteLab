apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: flights
  labels:
    name: flights
spec:
  serviceName: flights
  replicas: 2
  selector:
    matchLabels:
      name: flights
  podManagementPolicy: OrderedReady
  template:
    metadata:
      labels:
        name: flights
    spec:
      containers:
        - name: flights
          image: localhost:32000/flights
          imagePullPolicy: Always
          resources:
            requests:
              cpu: "100m"
              memory: "1024Mi"
            limits:
              cpu: "2"
              memory: "1024Mi"
          ports:
            - name: http
              containerPort: 7701
            - name: discovery1
              containerPort: 47701
            - name: discovery2
              containerPort: 47702
            - name: discovery3
              containerPort: 47703
            - name: comm1
              containerPort: 47100
            - name: comm2
              containerPort: 47101
            - name: comm3
              containerPort: 47102
            - name: comm4
              containerPort: 47103
          env:
            - name: IGNITE_UPDATE_NOTIFIER
              value: "false"
            - name: IGNITE_SKIP_CONFIGURATION_CONSISTENCY_CHECK
              value: "true"
            - name: SERVICE_OPTS
              value: |
                -Xmx512m
                -Dproperties=node.yaml
                -Dlogging.config=log4j2.xml
                -Dlog4j.shutdownHookEnabled=false
                -Dserver.port=7701
                -Dspring.profiles.active=dev
                -Djava.net.preferIPv4Stack=true
                -Dreactor.netty.ioWorkerCount=4
                -Dreactor.schedulers.defaultPoolSize=4
                -Dcluster.quorum=2
                --add-opens=java.base/jdk.internal.access=ALL-UNNAMED
                --add-opens=java.base/jdk.internal.misc=ALL-UNNAMED
                --add-opens=java.base/sun.nio.ch=ALL-UNNAMED
                --add-opens=java.base/sun.util.calendar=ALL-UNNAMED
                --add-opens=java.management/com.sun.jmx.mbeanserver=ALL-UNNAMED
                --add-opens=jdk.internal.jvmstat/sun.jvmstat.monitor=ALL-UNNAMED
                --add-opens=java.base/sun.reflect.generics.reflectiveObjects=ALL-UNNAMED
                --add-opens=jdk.management/com.sun.management.internal=ALL-UNNAMED
                --add-opens=java.base/java.io=ALL-UNNAMED
                --add-opens=java.base/java.nio=ALL-UNNAMED
                --add-opens=java.base/java.net=ALL-UNNAMED
                --add-opens=java.base/java.util=ALL-UNNAMED
                --add-opens=java.base/java.util.concurrent=ALL-UNNAMED
                --add-opens=java.base/java.util.concurrent.locks=ALL-UNNAMED
                --add-opens=java.base/java.util.concurrent.atomic=ALL-UNNAMED
                --add-opens=java.base/java.lang=ALL-UNNAMED
                --add-opens=java.base/java.lang.invoke=ALL-UNNAMED
                --add-opens=java.base/java.math=ALL-UNNAMED
                --add-opens=java.sql/java.sql=ALL-UNNAMED
                --add-opens=java.base/java.lang.reflect=ALL-UNNAMED
                --add-opens=java.base/java.time=ALL-UNNAMED
                --add-opens=java.base/java.text=ALL-UNNAMED
                --add-opens=java.management/sun.management=ALL-UNNAMED
                --add-opens=java.desktop/java.awt.font=ALL-UNNAMED






          command: ["sh", "-c"]
          args:
            - |
              cd /opt
              dos2unix *.sh
              chmod ug+x *.sh
              ./init.sh
              echo "SERVICE_OPTS=$SERVICE_OPTS"
              sleep 30
              java $SERVICE_OPTS -cp @/app/jib-classpath-file com.kaizensundays.flights.service.Main
      restartPolicy: Always
      terminationGracePeriodSeconds: 10

---
apiVersion: v1
kind: Service
metadata:
  name: flights
spec:
  selector:
    name: flights
  ports:
    - name: http
      port: 7701
      nodePort: 30711
  type: NodePort
